option nlp=pathnlp
;

Variables z,z_buyer,P(t),delta,l,h,y
;
Positive variables
      P,delta,l,
      h,y,
      w_P(t)            weight on energy price target
      w_delta           weight on capacity price target
      w_l               weight on local content target
      w_h               weight on financial warranties
      w_y               weight on years of experience
      w_total
      zeta(t)              dual variable on the capacity constraint
;

Equations
EQ_profit         "generator's profit"
EQ_caplim(t)      generators capacity limit constraint

EQ_buyer
EQ_P_s(t)
EQ_delta_s
EQ_l_s
eq_5_5(t)
Eq_5_6(t)
EQ_h_s
EQ_y_s
EQ_norm
EQ_q_pos(t)  generator production shold be non-negative

EQ_opt_delta(t)
EQ_opt_p(t)
EQ_opt_capacity(t)
;

$macro  PHI(t)    w_P(t)*(P_avg-P(t))/P_std \
                + w_delta*(delta_avg-delta)/delta_std \
                - w_h*(h_avg-h)/h_std \
                - w_l*(l_avg-l)/l_std \
                - w_y*(y_avg-y)/y_std

$macro RHO(x) 1/(1+exp(-(x)))

$macro profit(t) ((P(t) - c(l))*Q(P(t))+ (delta-f(l,y,h)*K(delta) ))

$macro c(l)      (ci*(1-l)+l*cl)
$macro f(l,y,h)      (fi*(1-l)+l*fl+y*tau_f+mu*h)
$macro theta(l,h)  (theta0-eps_L*l+eps_h*h)
$macro Q(P) (a-b*P)
$macro K(delta) (K0-g*delta)
$macro delta_opt(l,h) ((Q(P_avg)-theta(l,h)*K0)*delta_std+b*delta_avg*P_std)/(b*P_std-g*theta(l,h)*delta_std)
$macro P_opt(l,h) (-g*theta(l,h)*P_avg*delta_std+(a-K0*theta(l,h)+g*theta(l,h)*delta_avg)*P_std)/(b*P_std-g*theta(l,h)*delta_std)
$macro nu(l,h) (a-b*P_avg-K0*theta(l,h)+g*theta(l,h)*delta_avg)/(b*P_std-g*theta(l,h)*delta_std)
$macro h_opt h_avg-h_std*(a-b*P_avg-theta0*K0+theta0*g*delta_avg)/(b*P_std-g*theta0*delta_std)
$macro l_opt l_avg-l_std*(a-b*P_avg-theta0*K0+theta0*g*delta_avg)/(b*P_std-g*theta0*delta_std)
$macro y_opt y_avg-y_std*(a-b*P_avg-theta0*K0+theta0*g*delta_avg)/(b*P_std-g*theta0*delta_std)

EQ_opt_delta(t).. (k0 - 2*delta*g + g*f(l,y,h))/(1+exp(-PHI(t)))
        -w_delta*exp(-PHI(t))*profit(t)/(delta_std*(1+exp(-PHI(t)))**2)
        -g*theta(l,h)*zeta(t) =e= 0
;

EQ_opt_p(t).. (a+b*c(l)-2*b*P(t))/(1+exp(-PHI(t)))
  -w_P(t)*exp(-PHI(t))*profit(t)/(P_std*(1+exp(-PHI(t)))**2)
  +b*zeta(t) =e= 0
;

EQ_opt_capacity(t).. Q(P(t)) - theta(l,h)*K(delta) =e= 0
;

EQ_buyer..      z_buyer =e= sum(t,PHI(t))
;

EQ_norm(t).. w_P(t)+w_delta+w_y+w_l+w_h =e=1
;

EQ_profit.. z =e= sum(t,RHO(PHI(t))*profit(t))
;

EQ_caplim(t)..   Q(P(t))=l= theta(l,h)*(K0-g*delta)*8.760
;

EQ_q_pos(t).. Q(P(t)) =g= 0
;

EQ_P_s(t)..     P(t)=l= P0;
EQ_delta_s..     delta =l= delta0;
EQ_l_s..         l =g= l0;
EQ_h_s..         h=g= h0;
EQ_y_s..         y =g= y0;

l.up = 1.0;
h.up = 1.0;
*y.up = 10;

Model buyer /
EQ_buyer,
*EQ_P_s,
*EQ_delta_s,
*EQ_l_s,
*EQ_h_s,
*EQ_y_s,
EQ_norm
/;

Model buyer_gen_opt /
buyer,
EQ_caplim,
EQ_opt_delta,
EQ_opt_p,
EQ_opt_capacity
/;


model generator /
EQ_caplim,
EQ_profit,
*EQ_q_pos
/

model PPA /buyer generator/;

PPA.optfile=1;
PPA.savePoint=2;

file myinfo /'%emp.info%'/;
*put myinfo 'bilevel w_P w_delta w_h w_l w_y';
*put 'max z P delta h l y ';
*put 'EQ_profit EQ_caplim'
*put myinfo 'bilevel w_P w_delta w_h w_l w_y';
put 'dualvar zeta EQ_caplim';
put 'dualequ EQ_opt_delta delta';
put 'dualequ EQ_opt_p P';
put 'dualequ EQ_opt_capacity capacity';
$ontext
put 'EQ_P_s EQ_delta_s EQ_h_s EQ_y_s EQ_l_s';
put 'dualvar w_P EQ_P_s ';
put 'dualvar w_delta EQ_delta_s ';
put 'dualvar w_h EQ_h_s ';
put 'dualvar w_y EQ_y_s ';
put 'dualvar w_l EQ_l_s ';
$offtext

*rho phi theta K Q c f
putclose / myinfo;



